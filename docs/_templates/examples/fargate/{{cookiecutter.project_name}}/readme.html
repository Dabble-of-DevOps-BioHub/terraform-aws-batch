
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Batch - Fargate Example &#8212; BioAnalyze - AWS Batch Module</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://path_to_book/_templates/examples/fargate/{{cookiecutter.project_name}}/readme.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="AWS Fargate - Terraform" href="terraform.html" />
    <link rel="prev" title="Examples" href="../../../../examples/examples.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">BioAnalyze - AWS Batch Module</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../README.html">
   AWS Batch Terraform Module Latest Release
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../../../examples/examples.html">
   Examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     AWS Batch Fargate - Example Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="terraform.html">
     AWS Batch Fargate - Terraform
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../ec2/%7B%7Bcookiecutter.project_name%7D%7D/readme.html">
     AWS Batch EC2 - Example Module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../ec2/%7B%7Bcookiecutter.project_name%7D%7D/terraform.html">
     AWS Batch EC2 - Terraform
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../../_sources/_templates/examples/fargate/{{cookiecutter.project_name}}/readme.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quickstart">
   QuickStart
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-with-the-default-settings">
     Run with the default settings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supply-variables-from-a-configuration-file">
     Supply variables from a configuration file
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#from-the-cli">
       From the CLI
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#from-a-python-console">
       From a Python Console
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#customizing-your-deployment-with-terraform-variables">
   Customizing your Deployment with Terraform Variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-your-infrastructure">
   Deploy your Infrastructure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#save-share-and-reproduce-your-infrastructure">
   Save, Share and Reproduce your Infrastructure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#terraform-module-naming-convention">
   Terraform Module Naming Convention
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#terraform-resources">
   Terraform Resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="aws-batch-fargate-example">
<h1>AWS Batch - Fargate Example<a class="headerlink" href="#aws-batch-fargate-example" title="Permalink to this headline">¶</a></h1>
<p>This example shows how to deploy an AWS Batch cluster using the Fargate backend.</p>
<div class="section" id="quickstart">
<h2>QuickStart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using the BioAnalyze project templates assumes some familiarity with using a terminal, configuration formats, and Makefiles.</p>
</div>
<p>Run the cookiecutter command to generate a project template.</p>
<p>Your project name is a concatenation of <code class="docutils literal notranslate"><span class="pre">[&quot;namespace&quot;,</span> <span class="pre">&quot;environment&quot;,</span> <span class="pre">&quot;stage&quot;,</span> <span class="pre">&quot;name&quot;,</span> <span class="pre">&quot;attributes&quot;]</span></code> with <code class="docutils literal notranslate"><span class="pre">-</span></code> between. You can leave any of them out.</p>
<p>For example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;namespace&quot;</span> <span class="p">:</span> <span class="s2">&quot;bioanalyze&quot;</span><span class="p">,</span>
    <span class="nt">&quot;environment&quot;</span> <span class="p">:</span> <span class="s2">&quot;eks&quot;</span><span class="p">,</span>
    <span class="nt">&quot;stage&quot;</span> <span class="p">:</span> <span class="s2">&quot;dev&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Results in the project name: <code class="docutils literal notranslate"><span class="pre">bioanalyze-eks-dev</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before deploying your resources I <em>highly</em> recommend that you think about how you would like to name your resources. Choose a naming convention that makes sense for you.</p>
<p>Often I see projects the <code class="docutils literal notranslate"><span class="pre">namespace</span></code> based on lab, project, or analysis, <code class="docutils literal notranslate"><span class="pre">environment</span></code> as the AWS Infrastructure type such as Batch, SLURM, or Kubernetes, and stage as the usual <code class="docutils literal notranslate"><span class="pre">dev</span></code>, <code class="docutils literal notranslate"><span class="pre">stage</span></code>, <code class="docutils literal notranslate"><span class="pre">prod</span></code>.</p>
<p>Examples:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>namespace</p></th>
<th class="text-align:left head"><p>stage</p></th>
<th class="text-align:left head"><p>environment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>lab-a</p></td>
<td class="text-align:left"><p>dev, stage, prod</p></td>
<td class="text-align:left"><p>fargate-batch, ec2-batch, eks, slurm</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>lab-b</p></td>
<td class="text-align:left"><p>dev, stage, prod</p></td>
<td class="text-align:left"><p>fargate-batch, ec2-batch, eks, slurm</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>analysis-b</p></td>
<td class="text-align:left"><p>dev, stage, prod</p></td>
<td class="text-align:left"><p>fargate-batch, ec2-batch, eks, slurm</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>analysis-a</p></td>
<td class="text-align:left"><p>dev, stage, prod</p></td>
<td class="text-align:left"><p>fargate-batch, ec2-batch, eks, slurm</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="run-with-the-default-settings">
<h3>Run with the default settings<a class="headerlink" href="#run-with-the-default-settings" title="Permalink to this headline">¶</a></h3>
<p>The simplest way to run cookiecutter is by using the default CLI and running through the prompts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cookiecutter</span> \
	<span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">dabble</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">devops</span><span class="o">-</span><span class="n">bioanalyze</span><span class="o">/</span><span class="n">terraform</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="n">batch</span><span class="o">.</span><span class="n">git</span> \
	<span class="o">--</span><span class="n">directory</span> <span class="n">_templates</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">fargate</span>
</pre></div>
</div>
</div>
<div class="section" id="supply-variables-from-a-configuration-file">
<h3>Supply variables from a configuration file<a class="headerlink" href="#supply-variables-from-a-configuration-file" title="Permalink to this headline">¶</a></h3>
<p>Some recipes have a lot of variables, and you may not be ready to decide them all in one go.</p>
<p>If that is the case create a <code class="docutils literal notranslate"><span class="pre">config.json</span></code> file and feed that to cookiecutter. At a minimum you need to include your project name. For more information on naming schemas see. <a class="reference internal" href="#terraform-module-naming-convention"><span class="std std-ref">Terraform Module Naming Convention</span></a></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;namespace&quot;</span> <span class="p">:</span> <span class="s2">&quot;bioanalyze&quot;</span><span class="p">,</span>
    <span class="nt">&quot;environment&quot;</span> <span class="p">:</span> <span class="s2">&quot;eks&quot;</span><span class="p">,</span>
    <span class="nt">&quot;stage&quot;</span> <span class="p">:</span> <span class="s2">&quot;dev&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="from-the-cli">
<h4>From the CLI<a class="headerlink" href="#from-the-cli" title="Permalink to this headline">¶</a></h4>
<p>Run cookiecutter with your supplied config and use the suppress user input options.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cookiecutter <span class="se">\</span>
	git@github.com:dabble-of-devops-bioanalyze/terraform-aws-batch.git <span class="se">\</span>
	--directory _templates/examples/fargate <span class="se">\</span>
    --config-file path-to-config.json <span class="se">\</span>
    --no-input
</pre></div>
</div>
</div>
<div class="section" id="from-a-python-console">
<h4>From a Python Console<a class="headerlink" href="#from-a-python-console" title="Permalink to this headline">¶</a></h4>
<p>Or from a python script or console:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cookiecutter.main</span> <span class="kn">import</span> <span class="n">cookiecutter</span>

<span class="n">cookiecutter</span><span class="p">(</span><span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">dabble</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">devops</span><span class="o">-</span><span class="n">bioanalyze</span><span class="o">/</span><span class="n">terraform</span><span class="o">-</span><span class="n">aws</span><span class="o">-</span><span class="n">batch</span><span class="o">.</span><span class="n">git</span><span class="p">,</span>
        <span class="n">directory</span><span class="o">=</span><span class="n">_templates</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">fargate</span><span class="p">,</span>
        <span class="n">no_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># add your own namespace/environment/stage here</span>
        <span class="n">extra_context</span><span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;namespace&quot;</span> <span class="p">:</span> <span class="s2">&quot;bioanalyze&quot;</span><span class="p">,</span>
            <span class="s2">&quot;environment&quot;</span> <span class="p">:</span> <span class="s2">&quot;eks&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stage&quot;</span> <span class="p">:</span> <span class="s2">&quot;dev&quot;</span>
        <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="customizing-your-deployment-with-terraform-variables">
<h2>Customizing your Deployment with Terraform Variables<a class="headerlink" href="#customizing-your-deployment-with-terraform-variables" title="Permalink to this headline">¶</a></h2>
<p>From here take a look at the <code class="docutils literal notranslate"><span class="pre">terraform.example.tfvars</span></code> and the <code class="docutils literal notranslate"><span class="pre">terraform.example.tfvars.json</span></code> file.</p>
<p>Each of these files serves the same purpose, to add variables to our deployment. Pick one of these files and rename it remove the <code class="docutils literal notranslate"><span class="pre">.example</span></code> from the name.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp terraform.example.tfvars terraform.tfvars.json
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp terraform.example.tfvars terraform.tfvars.json
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure to use only one file, either the <code class="docutils literal notranslate"><span class="pre">tfvars</span></code> or the <code class="docutils literal notranslate"><span class="pre">tfvars.json</span></code>. Using both will make the computer lose it’s mind.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This quickstart is shared among many modules. For individual tips and tricks please see the documentation for that module.</p>
</div>
</div>
<div class="section" id="deploy-your-infrastructure">
<h2>Deploy your Infrastructure<a class="headerlink" href="#deploy-your-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>In any BioAnalyze project the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> is always the source of truth and light.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nb">help</span>
<span class="c1"># Initialize the terraform module. This does some sanity checks and downloads any needed external modules.</span>
make terraform/init
<span class="c1"># Planning will tell you what resources will be created/destroyed</span>
make terraform/plan
make terraform/apply
<span class="c1"># If you&#39;re sure you can run the auto-approve</span>
<span class="c1">#make terraform/apply/autoapprove</span>
</pre></div>
</div>
</div>
<div class="section" id="save-share-and-reproduce-your-infrastructure">
<h2>Save, Share and Reproduce your Infrastructure<a class="headerlink" href="#save-share-and-reproduce-your-infrastructure" title="Permalink to this headline">¶</a></h2>
<p>We use <a class="reference external" href="https://www.terraform.io/">Terraform</a> to deploy our resources in large part because it saves and backs up the state, which is mostly whether or not we have created our resources. By default running <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> will save your state to a <code class="docutils literal notranslate"><span class="pre">terraform.tfstate</span></code> file. You should not share this file publically or commit to a public github repo.</p>
<p>It is recommended to save your terraform state to a <a class="reference external" href="https://www.terraform.io/docs/language/settings/backends/remote.html">remote backend</a>. A single remote backend can house multiple deployments.</p>
<p>I recommend using the <a class="reference external" href="https://github.com/cloudposse/terraform-aws-tfstate-backend">Cloudposse Remote S3 Backend</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p terraform-remote-backend
<span class="nb">cd</span> terraform-remote-backend
touch main.tf
</pre></div>
</div>
<p>Grab this code and add it to your <code class="docutils literal notranslate"><span class="pre">main.tf</span></code> file.</p>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="c1"># main.tf</span>
<span class="kr">module</span> <span class="nv">&quot;terraform_state_backend&quot;</span> <span class="p">{</span>
   <span class="na">source</span> <span class="o">=</span> <span class="s2">&quot;cloudposse/tfstate-backend/aws&quot;</span><span class="c1"></span>
<span class="c1">   # Cloud Posse recommends pinning every module to a specific version</span>
<span class="c1">   # version     = &quot;x.x.x&quot;</span>
   <span class="na">namespace</span>  <span class="o">=</span> <span class="s2">&quot;YOUR_NAMESPACE&quot;</span>
   <span class="na">stage</span>      <span class="o">=</span> <span class="s2">&quot;YOUR_STAGE&quot;</span>
   <span class="na">name</span>       <span class="o">=</span> <span class="s2">&quot;terraform&quot;</span>
   <span class="na">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>

   <span class="na">terraform_backend_config_file_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
   <span class="na">terraform_backend_config_file_name</span> <span class="o">=</span> <span class="s2">&quot;backend.tf&quot;</span>
   <span class="na">force_destroy</span>                      <span class="o">=</span> <span class="no">false</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you have terraform installed locally you can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>terraform init
terraform plan
terraform apply -auto-approve
terraform init -force-copy
</pre></div>
</div>
<p>You can also grab the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> here and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the terraform module. This does some sanity checks and downloads any needed external modules.</span>
make terraform/init
<span class="c1"># Planning will tell you what resources will be created/destroyed</span>
make terraform/plan
<span class="c1"># If you&#39;re sure you can run the auto-approve</span>
make terraform/apply/autoapprove
make terraform/init/force-copy
</pre></div>
</div>
<p>You will now see a <code class="docutils literal notranslate"><span class="pre">backend.tf</span></code> file with your backend configuration. The configuration for the remote backend state is also saved in the <code class="docutils literal notranslate"><span class="pre">key</span></code>: <code class="docutils literal notranslate"><span class="pre">terraform.tfstate</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># backend.tf</span>
 <span class="n">backend</span> <span class="s2">&quot;s3&quot;</span> <span class="p">{</span>
   <span class="n">region</span>         <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
   <span class="n">bucket</span>         <span class="o">=</span> <span class="s2">&quot;&lt; the name of the S3 state bucket &gt;&quot;</span>
   <span class="n">key</span>            <span class="o">=</span> <span class="s2">&quot;terraform.tfstate&quot;</span>
   <span class="n">dynamodb_table</span> <span class="o">=</span> <span class="s2">&quot;&lt; the name of the DynamoDB locking table &gt;&quot;</span>
   <span class="n">profile</span>        <span class="o">=</span> <span class="s2">&quot;&quot;</span>
   <span class="n">role_arn</span>       <span class="o">=</span> <span class="s2">&quot;&quot;</span>
   <span class="n">encrypt</span>        <span class="o">=</span> <span class="n">true</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>In order to use this backend in another project copy the generated <code class="docutils literal notranslate"><span class="pre">backend.tf</span></code> file in your <code class="docutils literal notranslate"><span class="pre">terraform-remote-backend</span></code> directory, but change <code class="docutils literal notranslate"><span class="pre">key</span></code>.</p>
<p>Most often I use the backend <code class="docutils literal notranslate"><span class="pre">key</span></code> to house the <code class="docutils literal notranslate"><span class="pre">environment</span></code> tag.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>namespace</p></th>
<th class="text-align:left head"><p>stage</p></th>
<th class="text-align:left head"><p>environment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>bioanalyze</p></td>
<td class="text-align:left"><p>test</p></td>
<td class="text-align:left"><p>ec2-batch</p></td>
</tr>
</tbody>
</table>
<div class="highlight-terraform notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example terraform state for:</span>
<span class="c1"># namespace=bioanalyze</span>
<span class="c1"># stage=test</span>
<span class="c1"># environment=ec2-batch</span>

<span class="c1"># backend.tf</span>
 <span class="nb">terraform</span> <span class="p">{</span>
  <span class="na">required_version</span> <span class="o">=</span> <span class="s2">&quot;&gt;= 0.12.2&quot;</span>

  <span class="kr">backend</span> <span class="nv">&quot;s3&quot;</span> <span class="p">{</span>
    <span class="na">region</span>         <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
    <span class="na">bucket</span>         <span class="o">=</span> <span class="s2">&quot;bioanalyze-test-terraform-state&quot;</span>
    <span class="na">key</span>            <span class="o">=</span> <span class="s2">&quot;ec2-batch&quot;</span>
    <span class="na">dynamodb_table</span> <span class="o">=</span> <span class="s2">&quot;bioanalyze-test-terraform-state-lock&quot;</span>
    <span class="na">profile</span>        <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="na">role_arn</span>       <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="na">encrypt</span>        <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is an example directory structure.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
└── bioanalyze
    ├── dev
    │   ├── ec2-batch
    │   │   ├── backend.tf
    │   │   └── main.tf
    │   ├── eks
    │   │   ├── backend.tf
    │   │   └── main.tf
    │   └── fargate-batch
    │       ├── backend.tf
    │       └── main.tf
    ├── prod
    │   ├── ec2-batch
    │   │   ├── backend.tf
    │   │   └── main.tf
    │   ├── eks
    │   │   ├── backend.tf
    │   │   └── main.tf
    │   └── fargate-batch
    │       ├── backend.tf
    │       └── main.tf
</pre></div>
</div>
</div>
<div class="section" id="terraform-module-naming-convention">
<span id="id1"></span><h2>Terraform Module Naming Convention<a class="headerlink" href="#terraform-module-naming-convention" title="Permalink to this headline">¶</a></h2>
<p>This is a cookicutter template to create Terraform modules based on the <a class="reference external" href="https://www.bioanalyze.io">BioAnalyze</a> terraform recipe examples.</p>
<p>We use the <a class="reference external" href="https://github.com/cloudposse/terraform-example-module">CloudPosse</a> as a base, and the <a class="reference external" href="https://github.com/cloudposse/terraform-null-label">Label</a> module to generate a name.</p>
<p>The name is generated as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

<span class="n">label_order</span>         <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">,</span> <span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
<span class="n">id_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;namespace&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tenant&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;environment&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stage&quot;</span>       <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span>       <span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">label_order</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">id_context</span> <span class="ow">and</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_context</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>

<span class="n">id_full</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="kc">None</span>
</pre></div>
</div>
<p>You do not need to include all the labels. Usually I only use namespace, environment, and stage.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="o">=</span> <span class="s2">&quot;bioanalyze&quot;</span>
<span class="n">environment</span> <span class="o">=</span> <span class="s2">&quot;eks&quot;</span>
<span class="n">stage</span> <span class="o">=</span> <span class="s2">&quot;dev&quot;</span>
</pre></div>
</div>
<p>Would result in the project name <code class="docutils literal notranslate"><span class="pre">bioanalyze-eks-dev</span></code>.</p>
<p>Before you start creating multiple projects it’s recommended that you document your naming convention.</p>
</div>
<div class="section" id="terraform-resources">
<h2>Terraform Resources<a class="headerlink" href="#terraform-resources" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.terraform.io/docs/language/values/variables.html">Terraform Variables</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./_templates/examples/fargate/{{cookiecutter.project_name}}"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../../../../examples/examples.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Examples</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="terraform.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">AWS Fargate - Terraform</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By BioAnalyze<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>